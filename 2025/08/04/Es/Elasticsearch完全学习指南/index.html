<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/32X32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/16X16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CZCOOL+XiaoWei:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic%7CSource+Code+Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/orange/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"yoursite.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="学一下ES，另外这篇博客Cursor写的">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch学习指南">
<meta property="og:url" content="http://yoursite.com/2025/08/04/Es/Elasticsearch%E5%AE%8C%E5%85%A8%E5%AD%A6%E4%B9%A0%E6%8C%87%E5%8D%97/index.html">
<meta property="og:site_name" content="Hynis">
<meta property="og:description" content="学一下ES，另外这篇博客Cursor写的">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-08-03T17:05:43.000Z">
<meta property="article:modified_time" content="2025-08-03T17:05:54.061Z">
<meta property="article:author" content="Hynis">
<meta property="article:tag" content="elasticsearch">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://yoursite.com/2025/08/04/Es/Elasticsearch%E5%AE%8C%E5%85%A8%E5%AD%A6%E4%B9%A0%E6%8C%87%E5%8D%97/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://yoursite.com/2025/08/04/Es/Elasticsearch%E5%AE%8C%E5%85%A8%E5%AD%A6%E4%B9%A0%E6%8C%87%E5%8D%97/","path":"2025/08/04/Es/Elasticsearch完全学习指南/","title":"Elasticsearch学习指南"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Elasticsearch学习指南 | Hynis</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hynis</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">157</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">92</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">214</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">

<!-- 网易云外链-->
    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1439739102&auto=1&height=66"></iframe>
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>



      <div class="sidebar-panel-container">

        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Elasticsearch%E5%AD%A6%E4%B9%A0%E6%8C%87%E5%8D%97"><span class="nav-number">1.</span> <span class="nav-text">Elasticsearch学习指南</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E6%A6%82%E8%A7%88"><span class="nav-number">2.</span> <span class="nav-text">目录概览</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8"><span class="nav-number">3.</span> <span class="nav-text">第一部分：基础入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFElasticsearch%EF%BC%9F"><span class="nav-number">3.1.</span> <span class="nav-text">什么是Elasticsearch？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7"><span class="nav-number">3.1.1.</span> <span class="nav-text">核心特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">3.1.2.</span> <span class="nav-text">应用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">3.2.</span> <span class="nav-text">核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%9C%AF%E8%AF%AD%E5%AF%B9%E6%AF%94"><span class="nav-number">3.2.1.</span> <span class="nav-text">基本术语对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E4%B8%8E%E6%96%87%E6%A1%A3%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-number">3.2.2.</span> <span class="nav-text">索引与文档的关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88ES%E4%B8%AD%E7%9A%84%E2%80%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E2%80%9D%E8%A2%AB%E7%A7%B0%E4%B8%BA%E2%80%9D%E7%B4%A2%E5%BC%95%E2%80%9D%EF%BC%9F"><span class="nav-number">3.2.3.</span> <span class="nav-text">为什么ES中的“数据库”被称为”索引”？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mapping%E6%98%A0%E5%B0%84%E8%AF%A6%E8%A7%A3"><span class="nav-number">3.3.</span> <span class="nav-text">Mapping映射详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="nav-number">3.3.1.</span> <span class="nav-text">基本语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.3.2.</span> <span class="nav-text">常用数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#text-vs-keyword%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">3.3.3.</span> <span class="nav-text">text vs keyword的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C%E5%AE%9E%E6%88%98"><span class="nav-number">3.4.</span> <span class="nav-text">基础操作实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RESTful-API%E8%B7%AF%E5%BE%84%E8%A7%84%E8%8C%83"><span class="nav-number">3.4.1.</span> <span class="nav-text">RESTful API路径规范</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%B7%AF%E5%BE%84%E7%BB%93%E6%9E%84"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">基本路径结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8API%E8%B7%AF%E5%BE%84%E4%B8%80%E8%A7%88"><span class="nav-number">3.4.1.2.</span> <span class="nav-text">常用API路径一览</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E5%8F%82%E6%95%B0%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.4.1.3.</span> <span class="nav-text">路径参数示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A5%E5%85%85%E4%B8%80%E4%BA%9B%E7%89%B9%E6%AE%8A%E7%9A%84API%E8%B7%AF%E5%BE%84"><span class="nav-number">3.4.1.4.</span> <span class="nav-text">补充一些特殊的API路径</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95demo"><span class="nav-number">3.4.2.</span> <span class="nav-text">创建索引demo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%87%E6%A1%A3demo"><span class="nav-number">3.4.3.</span> <span class="nav-text">添加文档demo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%9F%A5%E8%AF%A2demo"><span class="nav-number">3.4.4.</span> <span class="nav-text">基础查询demo</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9A%E6%9F%A5%E8%AF%A2%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">第二部分：查询分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2%EF%BC%88Bool-Query%EF%BC%89"><span class="nav-number">4.1.</span> <span class="nav-text">复合查询（Bool Query）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E7%A7%8D%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6"><span class="nav-number">4.1.1.</span> <span class="nav-text">四种查询条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.1.2.</span> <span class="nav-text">实战示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90"><span class="nav-number">4.2.</span> <span class="nav-text">聚合分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E6%A0%87%E8%81%9A%E5%90%88"><span class="nav-number">4.2.1.</span> <span class="nav-text">指标聚合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%B6%E8%81%9A%E5%90%88"><span class="nav-number">4.2.2.</span> <span class="nav-text">桶聚合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F%E4%B8%8E%E5%88%86%E9%A1%B5"><span class="nav-number">4.3.</span> <span class="nav-text">排序与分页</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F"><span class="nav-number">4.3.1.</span> <span class="nav-text">多字段排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E7%AD%96%E7%95%A5"><span class="nav-number">4.3.2.</span> <span class="nav-text">分页策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E4%BA%AE%E6%90%9C%E7%B4%A2"><span class="nav-number">4.4.</span> <span class="nav-text">高亮搜索</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9A%E7%B3%BB%E7%BB%9F%E4%BC%98%E5%8C%96"><span class="nav-number">5.</span> <span class="nav-text">第三部分：系统优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="nav-number">5.1.</span> <span class="nav-text">核心参数详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0%E9%BB%98%E8%AE%A4%E5%80%BC%E4%B8%80%E8%A7%88"><span class="nav-number">5.1.1.</span> <span class="nav-text">核心参数默认值一览</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E7%BA%A7%E5%88%AB%E5%8F%82%E6%95%B0%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="nav-number">5.1.1.1.</span> <span class="nav-text">字段级别参数默认值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%BA%A7%E5%88%AB%E5%8F%82%E6%95%B0%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="nav-number">5.1.1.2.</span> <span class="nav-text">索引级别参数默认值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%BA%A7%E5%88%AB%E5%8F%82%E6%95%B0%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="nav-number">5.1.1.3.</span> <span class="nav-text">集群级别参数默认值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E5%99%A8%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="nav-number">5.1.1.4.</span> <span class="nav-text">分析器默认值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E7%B4%A2%E5%BC%95%E6%8E%A7%E5%88%B6"><span class="nav-number">5.1.2.</span> <span class="nav-text">字段索引控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">5.1.3.</span> <span class="nav-text">分析器配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%98%A0%E5%B0%84"><span class="nav-number">5.1.4.</span> <span class="nav-text">多字段映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%8F%82%E6%95%B0"><span class="nav-number">5.1.5.</span> <span class="nav-text">性能优化参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"><span class="nav-number">5.1.6.</span> <span class="nav-text">索引优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-number">5.1.7.</span> <span class="nav-text">查询优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93"><span class="nav-number">5.1.8.</span> <span class="nav-text">性能优化总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86"><span class="nav-number">5.2.</span> <span class="nav-text">集群管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E8%A7%92%E8%89%B2%E9%85%8D%E7%BD%AE"><span class="nav-number">5.2.1.</span> <span class="nav-text">节点角色配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E9%85%8D%E7%BD%AE%E5%8E%9F%E5%88%99"><span class="nav-number">5.2.2.</span> <span class="nav-text">内存配置原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="nav-number">5.2.3.</span> <span class="nav-text">分片策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%BF%90%E7%BB%B4"><span class="nav-number">5.3.</span> <span class="nav-text">监控与运维</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="nav-number">5.3.1.</span> <span class="nav-text">关键监控指标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"><span class="nav-number">5.3.2.</span> <span class="nav-text">故障排查</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%EF%BC%9A%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2"><span class="nav-number">6.</span> <span class="nav-text">第四部分：高级搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%BA%E6%80%A7%E5%8C%96%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD"><span class="nav-number">6.1.</span> <span class="nav-text">人性化搜索功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%99%BA%E8%83%BD%E6%90%9C%E7%B4%A2"><span class="nav-number">6.1.1.</span> <span class="nav-text">多字段智能搜索</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E9%94%99%E6%90%9C%E7%B4%A2"><span class="nav-number">6.1.2.</span> <span class="nav-text">容错搜索</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%E6%90%9C%E7%B4%A2"><span class="nav-number">6.2.</span> <span class="nav-text">地理位置搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%B0%E7%90%86%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1"><span class="nav-number">6.2.1.</span> <span class="nav-text">地理数据建模</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%9D%E7%A6%BB%E6%90%9C%E7%B4%A2"><span class="nav-number">6.2.2.</span> <span class="nav-text">距离搜索</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%99%BA%E8%83%BD%E8%A1%A5%E5%85%A8"><span class="nav-number">6.3.</span> <span class="nav-text">智能补全</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A5%E5%85%A8%E7%B4%A2%E5%BC%95%E8%AE%BE%E8%AE%A1"><span class="nav-number">6.3.1.</span> <span class="nav-text">补全索引设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A5%E5%85%A8%E6%9F%A5%E8%AF%A2"><span class="nav-number">6.3.2.</span> <span class="nav-text">补全查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E6%96%B9%E6%A1%88"><span class="nav-number">6.4.</span> <span class="nav-text">数据同步方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9"><span class="nav-number">6.4.1.</span> <span class="nav-text">同步方案选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MQ%E5%BC%82%E6%AD%A5%E5%90%8C%E6%AD%A5%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.4.2.</span> <span class="nav-text">MQ异步同步实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%EF%BC%9A%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="nav-number">7.</span> <span class="nav-text">第五部分：核心原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ES%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E4%B8%8EJVM"><span class="nav-number">7.1.</span> <span class="nav-text">ES技术架构与JVM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="nav-number">7.1.1.</span> <span class="nav-text">核心技术栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9Java%EF%BC%9F"><span class="nav-number">7.1.2.</span> <span class="nav-text">为什么选择Java？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86"><span class="nav-number">7.2.</span> <span class="nav-text">倒排索引原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%EF%BC%9F"><span class="nav-number">7.2.1.</span> <span class="nav-text">什么是倒排索引？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="nav-number">7.2.2.</span> <span class="nav-text">倒排索引存储结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E7%89%87%E4%B8%8E%E5%89%AF%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="nav-number">7.3.</span> <span class="nav-text">分片与副本原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%89%87%E8%AE%BE%E8%AE%A1%E7%9B%AE%E7%9A%84"><span class="nav-number">7.3.1.</span> <span class="nav-text">分片设计目的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E5%B8%83%E6%9C%BA%E5%88%B6"><span class="nav-number">7.3.2.</span> <span class="nav-text">数据分布机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%91%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A2%E5%8E%9F%E7%90%86"><span class="nav-number">7.4.</span> <span class="nav-text">近实时搜索原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93-vs-ES%E7%9A%84%E5%AE%9E%E6%97%B6%E6%80%A7"><span class="nav-number">7.4.1.</span> <span class="nav-text">传统数据库 vs ES的实时性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES%E5%AE%9E%E6%97%B6%E6%90%9C%E7%B4%A2%E6%B5%81%E7%A8%8B"><span class="nav-number">7.4.2.</span> <span class="nav-text">ES实时搜索流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E8%AF%8D%E5%99%A8%E5%8E%9F%E7%90%86"><span class="nav-number">7.5.</span> <span class="nav-text">分词器原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E8%AF%8D%E5%99%A8%E7%BB%84%E6%88%90%E6%9E%B6%E6%9E%84"><span class="nav-number">7.5.1.</span> <span class="nav-text">分词器组成架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E5%87%86%E5%88%86%E8%AF%8D%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">7.5.2.</span> <span class="nav-text">标准分词器工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E7%89%B9%E6%AE%8A%E6%80%A7"><span class="nav-number">7.5.3.</span> <span class="nav-text">中文分词特殊性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E5%8E%9F%E7%90%86"><span class="nav-number">7.6.</span> <span class="nav-text">聚合原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E7%B1%BB%E5%9E%8B%E5%88%92%E5%88%86"><span class="nav-number">7.6.1.</span> <span class="nav-text">聚合类型划分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%81%9A%E5%90%88%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="nav-number">7.6.2.</span> <span class="nav-text">聚合执行原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E5%8E%9F%E7%90%86"><span class="nav-number">7.7.</span> <span class="nav-text">分页原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B1%E5%88%86%E9%A1%B5%E9%97%AE%E9%A2%98%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0"><span class="nav-number">7.7.1.</span> <span class="nav-text">深分页问题根本原因</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#search-after%E5%8E%9F%E7%90%86"><span class="nav-number">7.7.2.</span> <span class="nav-text">search_after原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E5%8E%9F%E7%90%86"><span class="nav-number">7.8.</span> <span class="nav-text">查询优化原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#filter-vs-must-%E6%80%A7%E8%83%BD%E5%B7%AE%E5%BC%82"><span class="nav-number">7.8.1.</span> <span class="nav-text">filter vs must 性能差异</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="nav-number">7.8.2.</span> <span class="nav-text">查询缓存机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E9%94%99%E6%90%9C%E7%B4%A2%E5%8E%9F%E7%90%86"><span class="nav-number">7.9.</span> <span class="nav-text">容错搜索原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%EF%BC%88Fuzzy-Query%EF%BC%89%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80"><span class="nav-number">7.9.1.</span> <span class="nav-text">模糊查询（Fuzzy Query）算法基础</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fuzziness%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="nav-number">7.9.2.</span> <span class="nav-text">fuzziness参数详解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%BC%80%E9%95%BF%E5%BA%A6%E5%92%8C%E6%89%A9%E5%B1%95%E9%99%90%E5%88%B6"><span class="nav-number">7.9.3.</span> <span class="nav-text">前缀长度和扩展限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E9%94%99%E6%90%9C%E7%B4%A2%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">7.9.4.</span> <span class="nav-text">容错搜索的性能优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%99%BA%E8%83%BD%E8%A1%A5%E5%85%A8%E5%8E%9F%E7%90%86"><span class="nav-number">7.10.</span> <span class="nav-text">智能补全原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Completion-Suggester%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6"><span class="nav-number">7.10.1.</span> <span class="nav-text">Completion Suggester核心机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A5%E5%85%A8%E6%9F%A5%E8%AF%A2%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">7.10.2.</span> <span class="nav-text">补全查询的执行流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%87%8D%E8%AE%A1%E7%AE%97%E7%AD%96%E7%95%A5"><span class="nav-number">7.10.3.</span> <span class="nav-text">权重计算策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A5%E5%85%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">7.10.4.</span> <span class="nav-text">补全性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E8%AF%AD%E8%A8%80%E8%A1%A5%E5%85%A8%E6%94%AF%E6%8C%81"><span class="nav-number">7.10.5.</span> <span class="nav-text">多语言补全支持</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AF%E8%AF%AD%E6%A6%82%E5%BF%B5%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90"><span class="nav-number">7.11.</span> <span class="nav-text">术语概念深度解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88ES%E8%A2%AB%E7%A7%B0%E4%B8%BA%E2%80%9D%E7%B4%A2%E5%BC%95%E2%80%9D%EF%BC%9F"><span class="nav-number">7.11.1.</span> <span class="nav-text">为什么ES被称为”索引”？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E6%80%BB%E7%BB%93"><span class="nav-number">8.</span> <span class="nav-text">实战总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">8.1.</span> <span class="nav-text">最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-number">8.1.1.</span> <span class="nav-text">索引设计原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7"><span class="nav-number">8.1.2.</span> <span class="nav-text">查询优化技巧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-number">8.1.3.</span> <span class="nav-text">生产环境配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="nav-number">8.2.</span> <span class="nav-text">常见问题解决</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%E5%BC%82%E5%B8%B8"><span class="nav-number">8.2.1.</span> <span class="nav-text">集群状态异常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-number">8.2.2.</span> <span class="nav-text">性能问题排查</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Hynis"
      src="http://img.yesmylord.cn//1644852537960.jpg">
  <p class="site-author-name" itemprop="name">Hynis</p>
  <div class="site-description" itemprop="description">A blog about IT knowledge</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">214</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">92</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">157</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/YesYourHighness" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;YesYourHighness" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1046467756@qq.com" title="E-Mail → mailto:1046467756@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://zouper.cn/" title="https:&#x2F;&#x2F;zouper.cn" rel="noopener" target="_blank">一杯好茶</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.klenkiven.xyz/" title="https:&#x2F;&#x2F;www.klenkiven.xyz&#x2F;" rel="noopener" target="_blank">KlenKiven</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://hourunmeng.github.io/" title="https:&#x2F;&#x2F;hourunmeng.github.io&#x2F;" rel="noopener" target="_blank">润萌</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://flashxin.github.io/" title="https:&#x2F;&#x2F;flashxin.github.io&#x2F;" rel="noopener" target="_blank">flashxin</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/YesYourHighness" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/08/04/Es/Elasticsearch%E5%AE%8C%E5%85%A8%E5%AD%A6%E4%B9%A0%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://img.yesmylord.cn//1644852537960.jpg">
      <meta itemprop="name" content="Hynis">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hynis">
      <meta itemprop="description" content="A blog about IT knowledge">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Elasticsearch学习指南 | Hynis">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Elasticsearch学习指南
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-08-04 01:05:43 / 修改时间：01:05:54" itemprop="dateCreated datePublished" datetime="2025-08-04T01:05:43+08:00">2025-08-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/elasticsearch/" itemprop="url" rel="index"><span itemprop="name">elasticsearch</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>33k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>30 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
         <center>
学一下ES，另外这篇博客Cursor写的
</center>

<span id="more"></span>

<h1 id="Elasticsearch学习指南"><a href="#Elasticsearch学习指南" class="headerlink" title="Elasticsearch学习指南"></a>Elasticsearch学习指南</h1><h1 id="目录概览"><a href="#目录概览" class="headerlink" title="目录概览"></a>目录概览</h1><p>本指南分为五个主要部分，逐步深入Elasticsearch的学习：</p>
<ol>
<li><strong>基础入门</strong> - ES核心概念与基础操作</li>
<li><strong>查询分析</strong> - 高级查询与数据分析技术</li>
<li><strong>系统优化</strong> - 性能优化与集群运维</li>
<li><strong>高级搜索</strong> - 人性化搜索功能与企业级应用</li>
<li><strong>核心原理</strong> - 底层机制与性能原理深度剖析</li>
</ol>
<hr>
<h1 id="第一部分：基础入门"><a href="#第一部分：基础入门" class="headerlink" title="第一部分：基础入门"></a>第一部分：基础入门</h1><h2 id="什么是Elasticsearch？"><a href="#什么是Elasticsearch？" class="headerlink" title="什么是Elasticsearch？"></a>什么是Elasticsearch？</h2><p>Elasticsearch是一个基于Apache Lucene构建的<strong>分布式搜索和分析引擎</strong>，专门用于处理大量数据的实时搜索、分析和可视化。</p>
<h3 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;分布式架构&quot;</span><span class="punctuation">:</span> <span class="string">&quot;多节点集群，自动分片和复制&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;RESTful API&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HTTP请求操作，简单易用&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;JSON文档&quot;</span><span class="punctuation">:</span> <span class="string">&quot;灵活的数据结构&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;近实时搜索&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数据写入后几乎立即可搜索&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;强大分析&quot;</span><span class="punctuation">:</span> <span class="string">&quot;支持复杂的聚合查询&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>具体应用</th>
<th>典型案例</th>
</tr>
</thead>
<tbody><tr>
<td><strong>搜索引擎</strong></td>
<td>全文搜索、商品搜索</td>
<td>淘宝商品搜索、知乎文章搜索</td>
</tr>
<tr>
<td><strong>日志分析</strong></td>
<td>系统监控、错误分析</td>
<td>ELK日志分析平台</td>
</tr>
<tr>
<td><strong>实时分析</strong></td>
<td>用户行为、业务指标</td>
<td>网站访问统计、销售数据分析</td>
</tr>
<tr>
<td><strong>地理搜索</strong></td>
<td>位置服务、配送范围</td>
<td>外卖应用、地图服务</td>
</tr>
</tbody></table>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="基本术语对比"><a href="#基本术语对比" class="headerlink" title="基本术语对比"></a>基本术语对比</h3><table>
<thead>
<tr>
<th>Elasticsearch</th>
<th>关系数据库</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Index</td>
<td>Database</td>
<td>索引，类似数据库</td>
</tr>
<tr>
<td>Document</td>
<td>Row</td>
<td>文档，JSON格式的数据记录</td>
</tr>
<tr>
<td>Field</td>
<td>Column</td>
<td>字段，文档中的属性</td>
</tr>
<tr>
<td>Mapping</td>
<td>Schema</td>
<td>映射，定义字段类型和属性</td>
</tr>
</tbody></table>
<h3 id="索引与文档的关系"><a href="#索引与文档的关系" class="headerlink" title="索引与文档的关系"></a>索引与文档的关系</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">索引(Index) = 一个业务领域的数据集合</span><br><span class="line">└── 文档(Document) = 具体的数据记录</span><br><span class="line">    ├── 字段1: 值1</span><br><span class="line">    ├── 字段2: 值2</span><br><span class="line">    └── 字段3: 值3</span><br></pre></td></tr></table></figure>

<h3 id="为什么ES中的“数据库”被称为”索引”？"><a href="#为什么ES中的“数据库”被称为”索引”？" class="headerlink" title="为什么ES中的“数据库”被称为”索引”？"></a>为什么ES中的“数据库”被称为”索引”？</h3><p>ES中的”索引”概念继承自搜索引擎领域，具有双重含义：</p>
<ul>
<li><strong>数据容器</strong>：类似关系数据库的Database，存储相关数据的逻辑集合</li>
<li><strong>搜索索引</strong>：基于倒排索引的快速检索数据结构</li>
</ul>
<p>这种命名体现了ES作为搜索引擎的本质特征。<strong>详细原理请参考第五部分。</strong></p>
<h2 id="Mapping映射详解"><a href="#Mapping映射详解" class="headerlink" title="Mapping映射详解"></a>Mapping映射详解</h2><p>Mapping是ES的核心概念，定义了文档的结构和字段属性。</p>
<h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>           <span class="comment">// 固定关键字：映射定义</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>       <span class="comment">// 固定关键字：字段容器</span></span><br><span class="line">      <span class="attr">&quot;字段名&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数据类型&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;其他属性&quot;</span><span class="punctuation">:</span> <span class="string">&quot;值&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="常用数据类型"><a href="#常用数据类型" class="headerlink" title="常用数据类型"></a>常用数据类型</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span>      <span class="comment">// 全文搜索</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span>  <span class="comment">// 精确匹配</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;float&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span>     <span class="comment">// 浮点数</span></span><br><span class="line">      <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span>   <span class="comment">// 整数</span></span><br><span class="line">      <span class="attr">&quot;published&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span>  <span class="comment">// 日期</span></span><br><span class="line">      <span class="attr">&quot;active&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span><span class="punctuation">&#125;</span>   <span class="comment">// 布尔值</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="text-vs-keyword的区别"><a href="#text-vs-keyword的区别" class="headerlink" title="text vs keyword的区别"></a>text vs keyword的区别</h3><p><strong>核心差异：</strong></p>
<ul>
<li><code>text</code>: 会分词，支持模糊搜索</li>
<li><code>keyword</code>: 不分词，只支持精确匹配</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;示例对比&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;原文&quot;</span><span class="punctuation">:</span> <span class="string">&quot;计算机科学&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;text处理&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;计算机&quot;</span><span class="punctuation">,</span> <span class="string">&quot;科学&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span>  <span class="comment">// 分词后可搜索&quot;计算机&quot;</span></span><br><span class="line">    <span class="attr">&quot;keyword处理&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;计算机科学&quot;</span><span class="punctuation">]</span>   <span class="comment">// 必须完整匹配&quot;计算机科学&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="基础操作实战"><a href="#基础操作实战" class="headerlink" title="基础操作实战"></a>基础操作实战</h2><h3 id="RESTful-API路径规范"><a href="#RESTful-API路径规范" class="headerlink" title="RESTful API路径规范"></a>RESTful API路径规范</h3><p>Elasticsearch遵循RESTful设计，所有操作都通过HTTP请求完成。理解API路径规律是掌握ES的关键。</p>
<h4 id="基本路径结构"><a href="#基本路径结构" class="headerlink" title="基本路径结构"></a>基本路径结构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://host:port/&#123;index_name&#125;/&#123;api_type&#125;/&#123;document_id&#125;</span><br><span class="line">                  ↑           ↑           ↑</span><br><span class="line">                索引名     API类型      文档ID(可选)</span><br></pre></td></tr></table></figure>

<h4 id="常用API路径一览"><a href="#常用API路径一览" class="headerlink" title="常用API路径一览"></a>常用API路径一览</h4><table>
<thead>
<tr>
<th>操作类型</th>
<th>HTTP方法</th>
<th>路径格式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>索引管理</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>创建索引</td>
<td><code>PUT</code></td>
<td><code>/&#123;index_name&#125;</code></td>
<td>创建新索引</td>
</tr>
<tr>
<td>删除索引</td>
<td><code>DELETE</code></td>
<td><code>/&#123;index_name&#125;</code></td>
<td>删除整个索引</td>
</tr>
<tr>
<td>查看索引</td>
<td><code>GET</code></td>
<td><code>/&#123;index_name&#125;</code></td>
<td>获取索引信息</td>
</tr>
<tr>
<td><strong>文档操作</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>添加文档(指定ID)</td>
<td><code>PUT</code></td>
<td><code>/&#123;index_name&#125;/_doc/&#123;doc_id&#125;</code></td>
<td>指定文档ID</td>
</tr>
<tr>
<td>添加文档(自动ID)</td>
<td><code>POST</code></td>
<td><code>/&#123;index_name&#125;/_doc</code></td>
<td>系统自动生成ID</td>
</tr>
<tr>
<td>更新文档(全量)</td>
<td><code>PUT</code></td>
<td><code>/&#123;index_name&#125;/_doc/&#123;doc_id&#125;</code></td>
<td>完全替换文档</td>
</tr>
<tr>
<td>更新文档(部分)</td>
<td><code>POST</code></td>
<td><code>/&#123;index_name&#125;/_update/&#123;doc_id&#125;</code></td>
<td>部分字段更新</td>
</tr>
<tr>
<td>删除文档</td>
<td><code>DELETE</code></td>
<td><code>/&#123;index_name&#125;/_doc/&#123;doc_id&#125;</code></td>
<td>删除指定文档</td>
</tr>
<tr>
<td><strong>查询操作</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>根据ID查询</td>
<td><code>GET</code></td>
<td><code>/&#123;index_name&#125;/_doc/&#123;doc_id&#125;</code></td>
<td>精确ID查询</td>
</tr>
<tr>
<td>简单搜索</td>
<td><code>GET</code></td>
<td><code>/&#123;index_name&#125;/_search</code></td>
<td>基础搜索</td>
</tr>
<tr>
<td>复杂搜索</td>
<td><code>POST</code></td>
<td><code>/&#123;index_name&#125;/_search</code></td>
<td>复杂查询条件</td>
</tr>
<tr>
<td>全库搜索</td>
<td><code>GET</code></td>
<td><code>/_search</code></td>
<td>搜索所有索引</td>
</tr>
<tr>
<td><strong>批量操作</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>批量处理</td>
<td><code>POST</code></td>
<td><code>/_bulk</code></td>
<td>批量增删改</td>
</tr>
</tbody></table>
<h4 id="路径参数示例"><a href="#路径参数示例" class="headerlink" title="路径参数示例"></a>路径参数示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例解析</span></span><br><span class="line">PUT http://localhost:9200/students/_doc/1</span><br><span class="line"><span class="comment">#    ↑                    ↑        ↑     ↑</span></span><br><span class="line"><span class="comment">#   协议://主机:端口      索引名   API类型 文档ID</span></span><br><span class="line">POST http://localhost:9200/students/_search</span><br><span class="line"><span class="comment">#                          ↑        ↑</span></span><br><span class="line"><span class="comment">#                        索引名   搜索API</span></span><br></pre></td></tr></table></figure>

<h4 id="补充一些特殊的API路径"><a href="#补充一些特殊的API路径" class="headerlink" title="补充一些特殊的API路径"></a>补充一些特殊的API路径</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 集群管理</span></span><br><span class="line">GET /_cluster/health         <span class="comment"># 集群健康状态</span></span><br><span class="line">GET /_cat/indices            <span class="comment"># 查看所有索引</span></span><br><span class="line">GET /_cat/nodes              <span class="comment"># 查看所有节点</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 索引模板和别名</span></span><br><span class="line">GET /_template               <span class="comment"># 查看索引模板</span></span><br><span class="line">GET /_alias                  <span class="comment"># 查看索引别名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计信息</span></span><br><span class="line">GET /_stats                  <span class="comment"># 全局统计</span></span><br><span class="line">GET /students/_stats         <span class="comment"># 特定索引统计</span></span><br></pre></td></tr></table></figure>

<h3 id="创建索引demo"><a href="#创建索引demo" class="headerlink" title="创建索引demo"></a>创建索引demo</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建学生信息索引</span></span><br><span class="line">curl -X PUT <span class="string">&quot;localhost:9200/students&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;mappings&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &#123;&quot;type&quot;: &quot;text&quot;&#125;,</span></span><br><span class="line"><span class="string">      &quot;age&quot;: &#123;&quot;type&quot;: &quot;integer&quot;&#125;,</span></span><br><span class="line"><span class="string">      &quot;major&quot;: &#123;&quot;type&quot;: &quot;keyword&quot;&#125;,</span></span><br><span class="line"><span class="string">      &quot;gpa&quot;: &#123;&quot;type&quot;: &quot;float&quot;&#125;,</span></span><br><span class="line"><span class="string">      &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="添加文档demo"><a href="#添加文档demo" class="headerlink" title="添加文档demo"></a>添加文档demo</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加学生记录</span></span><br><span class="line">curl -X PUT <span class="string">&quot;localhost:9200/students/_doc/1&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;name&quot;: &quot;张三&quot;,</span></span><br><span class="line"><span class="string">  &quot;age&quot;: 20,</span></span><br><span class="line"><span class="string">  &quot;major&quot;: &quot;计算机科学&quot;,</span></span><br><span class="line"><span class="string">  &quot;gpa&quot;: 3.8,</span></span><br><span class="line"><span class="string">  &quot;created_at&quot;: &quot;2024-01-15&quot;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="基础查询demo"><a href="#基础查询demo" class="headerlink" title="基础查询demo"></a>基础查询demo</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查询所有文档</span></span><br><span class="line">curl -X GET <span class="string">&quot;localhost:9200/students/_search&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 根据ID查询</span></span><br><span class="line">curl -X GET <span class="string">&quot;localhost:9200/students/_doc/1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 按名字搜索</span></span><br><span class="line">curl -X POST <span class="string">&quot;localhost:9200/students/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;match&quot;: &#123;&quot;name&quot;: &quot;张三&quot;&#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 范围查询（GPA &gt; 3.5）</span></span><br><span class="line">curl -X POST <span class="string">&quot;localhost:9200/students/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;range&quot;: &#123;&quot;gpa&quot;: &#123;&quot;gte&quot;: 3.5&#125;&#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第二部分：查询分析"><a href="#第二部分：查询分析" class="headerlink" title="第二部分：查询分析"></a>第二部分：查询分析</h1><h2 id="复合查询（Bool-Query）"><a href="#复合查询（Bool-Query）" class="headerlink" title="复合查询（Bool Query）"></a>复合查询（Bool Query）</h2><p>Bool查询是ES最强大的查询类型，可以组合多个查询条件。</p>
<h3 id="四种查询条件"><a href="#四种查询条件" class="headerlink" title="四种查询条件"></a>四种查询条件</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>     <span class="comment">// 必须匹配（AND），参与评分</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>   <span class="comment">// 必须匹配（AND），不参与评分，性能更好</span></span><br><span class="line">      <span class="attr">&quot;should&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span>   <span class="comment">// 应该匹配（OR）</span></span><br><span class="line">      <span class="attr">&quot;must_not&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span>  <span class="comment">// 必须不匹配（NOT）</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="实战示例"><a href="#实战示例" class="headerlink" title="实战示例"></a>实战示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂组合查询：年龄20-25岁，专业为&quot;计算机科学&quot;或&quot;数据科学&quot;，GPA不低于3.0</span></span><br><span class="line">curl -X POST <span class="string">&quot;localhost:9200/students/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;bool&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;filter&quot;: [</span></span><br><span class="line"><span class="string">        &#123;&quot;range&quot;: &#123;&quot;age&quot;: &#123;&quot;gte&quot;: 20, &quot;lte&quot;: 25&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">      ],</span></span><br><span class="line"><span class="string">      &quot;should&quot;: [</span></span><br><span class="line"><span class="string">        &#123;&quot;term&quot;: &#123;&quot;major&quot;: &quot;计算机科学&quot;&#125;&#125;,</span></span><br><span class="line"><span class="string">        &#123;&quot;term&quot;: &#123;&quot;major&quot;: &quot;数据科学&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">      ],</span></span><br><span class="line"><span class="string">      &quot;must_not&quot;: [</span></span><br><span class="line"><span class="string">        &#123;&quot;range&quot;: &#123;&quot;gpa&quot;: &#123;&quot;lt&quot;: 3.0&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">      ],</span></span><br><span class="line"><span class="string">      &quot;minimum_should_match&quot;: 1</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="聚合分析"><a href="#聚合分析" class="headerlink" title="聚合分析"></a>聚合分析</h2><p>聚合查询用于数据统计和分析，提供了强大的数据洞察能力。</p>
<p>聚合分为<strong>指标聚合</strong>（计算数值）和<strong>桶聚合</strong>（分组统计），可以灵活组合使用。<strong>详细原理请参考第五部分。</strong></p>
<h3 id="指标聚合"><a href="#指标聚合" class="headerlink" title="指标聚合"></a>指标聚合</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算平均GPA和多项统计</span></span><br><span class="line">curl -X POST <span class="string">&quot;localhost:9200/students/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;aggs&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;avg_gpa&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;avg&quot;: &#123;&quot;field&quot;: &quot;gpa&quot;&#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;gpa_stats&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;stats&quot;: &#123;&quot;field&quot;: &quot;gpa&quot;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;size&quot;: 0</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="桶聚合"><a href="#桶聚合" class="headerlink" title="桶聚合"></a>桶聚合</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按专业分组统计，并计算每组平均GPA</span></span><br><span class="line">curl -X POST <span class="string">&quot;localhost:9200/students/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;aggs&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;major_analysis&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;terms&quot;: &#123;&quot;field&quot;: &quot;major&quot;&#125;,</span></span><br><span class="line"><span class="string">      &quot;aggs&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;avg_gpa&quot;: &#123;&quot;avg&quot;: &#123;&quot;field&quot;: &quot;gpa&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;size&quot;: 0</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="排序与分页"><a href="#排序与分页" class="headerlink" title="排序与分页"></a>排序与分页</h2><h3 id="多字段排序"><a href="#多字段排序" class="headerlink" title="多字段排序"></a>多字段排序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按GPA降序，年龄升序排列</span></span><br><span class="line">curl -X POST <span class="string">&quot;localhost:9200/students/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;,</span></span><br><span class="line"><span class="string">  &quot;sort&quot;: [</span></span><br><span class="line"><span class="string">    &#123;&quot;gpa&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;,</span></span><br><span class="line"><span class="string">    &#123;&quot;age&quot;: &#123;&quot;order&quot;: &quot;asc&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="分页策略"><a href="#分页策略" class="headerlink" title="分页策略"></a>分页策略</h3><p>ES提供两种分页方式：from/size适合小数据量，search_after适合大数据量。深分页会导致性能问题，建议大数据量场景使用search_after。<strong>详细原理请参考第五部分。</strong></p>
<p><strong>小数据量：from/size分页</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">&quot;localhost:9200/students/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;,</span></span><br><span class="line"><span class="string">  &quot;from&quot;: 10,</span></span><br><span class="line"><span class="string">  &quot;size&quot;: 10,</span></span><br><span class="line"><span class="string">  &quot;sort&quot;: [&#123;&quot;gpa&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;]</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>大数据量：search_after分页（推荐）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">&quot;localhost:9200/students/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;,</span></span><br><span class="line"><span class="string">  &quot;size&quot;: 10,</span></span><br><span class="line"><span class="string">  &quot;sort&quot;: [</span></span><br><span class="line"><span class="string">    &#123;&quot;gpa&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;,</span></span><br><span class="line"><span class="string">    &#123;&quot;_id&quot;: &#123;&quot;order&quot;: &quot;asc&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;search_after&quot;: [3.8, &quot;student_id_123&quot;]</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="高亮搜索"><a href="#高亮搜索" class="headerlink" title="高亮搜索"></a>高亮搜索</h2><p>高亮功能可以在搜索结果中突出显示匹配的关键词。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索并高亮姓名字段</span></span><br><span class="line">curl -X POST <span class="string">&quot;localhost:9200/students/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;match&quot;: &#123;&quot;name&quot;: &quot;张&quot;&#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;highlight&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;pre_tags&quot;: [&quot;&lt;mark&gt;&quot;],</span></span><br><span class="line"><span class="string">    &quot;post_tags&quot;: [&quot;&lt;/mark&gt;&quot;],</span></span><br><span class="line"><span class="string">    &quot;fields&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第三部分：系统优化"><a href="#第三部分：系统优化" class="headerlink" title="第三部分：系统优化"></a>第三部分：系统优化</h1><h2 id="核心参数详解"><a href="#核心参数详解" class="headerlink" title="核心参数详解"></a>核心参数详解</h2><p>掌握ES的核心参数是进行高级优化的基础，按功能分为以下几类：</p>
<h3 id="核心参数默认值一览"><a href="#核心参数默认值一览" class="headerlink" title="核心参数默认值一览"></a>核心参数默认值一览</h3><p>了解参数默认值有助于理解ES的默认行为和优化方向：</p>
<h4 id="字段级别参数默认值"><a href="#字段级别参数默认值" class="headerlink" title="字段级别参数默认值"></a>字段级别参数默认值</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>默认值</th>
<th>数据类型适用</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>index</strong></td>
<td><code>true</code></td>
<td>所有类型</td>
<td>字段可被搜索</td>
</tr>
<tr>
<td><strong>store</strong></td>
<td><code>false</code></td>
<td>所有类型</td>
<td>不独立存储字段值</td>
</tr>
<tr>
<td><strong>doc_values</strong></td>
<td><code>true</code></td>
<td>keyword, numeric, date等</td>
<td>支持排序和聚合</td>
</tr>
<tr>
<td><strong>norms</strong></td>
<td><code>true</code></td>
<td>text字段</td>
<td>启用长度归一化（评分用）</td>
</tr>
<tr>
<td><strong>eager_global_ordinals</strong></td>
<td><code>false</code></td>
<td>keyword字段</td>
<td>不预计算聚合</td>
</tr>
<tr>
<td><strong>fielddata</strong></td>
<td><code>false</code></td>
<td>text字段</td>
<td>禁用内存聚合</td>
</tr>
<tr>
<td><strong>ignore_above</strong></td>
<td><code>256</code></td>
<td>keyword字段</td>
<td>超长字符串截断长度</td>
</tr>
<tr>
<td><strong>null_value</strong></td>
<td><code>null</code></td>
<td>所有类型</td>
<td>空值不索引</td>
</tr>
<tr>
<td><strong>coerce</strong></td>
<td><code>true</code></td>
<td>numeric字段</td>
<td>自动类型转换</td>
</tr>
<tr>
<td><strong>boost</strong></td>
<td><code>1.0</code></td>
<td>所有类型</td>
<td>字段权重系数</td>
</tr>
</tbody></table>
<h4 id="索引级别参数默认值"><a href="#索引级别参数默认值" class="headerlink" title="索引级别参数默认值"></a>索引级别参数默认值</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>refresh_interval</strong></td>
<td><code>1s</code></td>
<td>数据刷新间隔</td>
</tr>
<tr>
<td><strong>number_of_shards</strong></td>
<td><code>1</code></td>
<td>主分片数量</td>
</tr>
<tr>
<td><strong>number_of_replicas</strong></td>
<td><code>1</code></td>
<td>副本分片数量</td>
</tr>
<tr>
<td><strong>max_result_window</strong></td>
<td><code>10000</code></td>
<td>from+size最大值</td>
</tr>
<tr>
<td><strong>max_rescore_window</strong></td>
<td><code>10000</code></td>
<td>重评分窗口大小</td>
</tr>
</tbody></table>
<h4 id="集群级别参数默认值"><a href="#集群级别参数默认值" class="headerlink" title="集群级别参数默认值"></a>集群级别参数默认值</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>cluster.routing.allocation.disk.watermark.low</strong></td>
<td><code>85%</code></td>
<td>磁盘使用率低水位线</td>
</tr>
<tr>
<td><strong>cluster.routing.allocation.disk.watermark.high</strong></td>
<td><code>90%</code></td>
<td>磁盘使用率高水位线</td>
</tr>
<tr>
<td><strong>indices.memory.index_buffer_size</strong></td>
<td><code>10%</code></td>
<td>索引缓冲区大小</td>
</tr>
<tr>
<td><strong>thread_pool.write.queue_size</strong></td>
<td><code>200</code></td>
<td>写入队列大小</td>
</tr>
</tbody></table>
<h4 id="分析器默认值"><a href="#分析器默认值" class="headerlink" title="分析器默认值"></a>分析器默认值</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>analyzer</strong></td>
<td><code>standard</code></td>
<td>默认分析器</td>
</tr>
<tr>
<td><strong>search_analyzer</strong></td>
<td>同analyzer</td>
<td>搜索时分析器</td>
</tr>
<tr>
<td><strong>normalizer</strong></td>
<td>无</td>
<td>keyword字段标准化器</td>
</tr>
</tbody></table>
<h3 id="字段索引控制"><a href="#字段索引控制" class="headerlink" title="字段索引控制"></a>字段索引控制</h3><p><strong>index参数</strong> - 控制字段是否可搜索</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>     <span class="comment">// 可搜索</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;internal_data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span>    <span class="comment">// 只存储，不可搜索，节省空间</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>store参数</strong> - 控制字段独立存储</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;summary&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;store&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>       <span class="comment">// 独立存储，快速访问</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="分析器配置"><a href="#分析器配置" class="headerlink" title="分析器配置"></a>分析器配置</h3><p><strong>analyzer和search_analyzer</strong> - 分别控制索引和搜索时的分词器</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;product_name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span>      <span class="comment">// 索引时精细分词</span></span><br><span class="line">    <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span>   <span class="comment">// 搜索时智能分词</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="多字段映射"><a href="#多字段映射" class="headerlink" title="多字段映射"></a>多字段映射</h3><p><strong>fields参数</strong> - 一个字段多种用途</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span>               <span class="comment">// 主字段：全文搜索</span></span><br><span class="line">    <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                <span class="comment">// 子字段：精确匹配</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;suggest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>                <span class="comment">// 子字段：自动补全</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;completion&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="性能优化参数"><a href="#性能优化参数" class="headerlink" title="性能优化参数"></a>性能优化参数</h3><p><strong>doc_values</strong> - 控制列式存储（用于排序、聚合）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;doc_values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span>    <span class="comment">// 纯ID字段，禁用节省空间</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>eager_global_ordinals</strong> - 预计算聚合性能</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;category&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;eager_global_ordinals&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>    <span class="comment">// 经常聚合的字段启用</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h3><p><strong>批量索引配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时优化设置（批量导入时）</span></span><br><span class="line">curl -X PUT <span class="string">&quot;localhost:9200/my_index/_settings&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;refresh_interval&quot;: -1,        // 禁用自动刷新</span></span><br><span class="line"><span class="string">  &quot;number_of_replicas&quot;: 0        // 临时移除副本</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量导入后恢复设置</span></span><br><span class="line">curl -X PUT <span class="string">&quot;localhost:9200/my_index/_settings&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;refresh_interval&quot;: &quot;1s&quot;,</span></span><br><span class="line"><span class="string">  &quot;number_of_replicas&quot;: 1</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h3><p>filter查询比must查询性能更好，因为filter不计算评分且支持查询缓存。过滤场景优先使用filter，搜索排序场景使用must。<strong>详细性能原理请参考第五部分。</strong></p>
<p><strong>使用filter替代must（性能更好）</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;优化前&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;must&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;active&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;优化后&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;bool&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;filter&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;range&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;gte&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="attr">&quot;term&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;active&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="性能优化总结"><a href="#性能优化总结" class="headerlink" title="性能优化总结"></a>性能优化总结</h3><p><strong>ES性能优化SOP：</strong></p>
<ol>
<li> 先分析业务场景和数据特征</li>
<li>再根据读写比例确定优化重点</li>
<li>最后通过监控验证优化效果</li>
</ol>
<p><strong>性能优化策略：</strong></p>
<ul>
<li>存储优化: “禁用不需要的功能（index、doc_values、norms、store）</li>
<li>查询优化”: “预计算高频操作（eager_global_ordinals）+ 合理缓存</li>
<li>写入优化”: “批量操作时临时调整refresh_interval和副本数</li>
<li>集群优化”: “合理分片 + 充足资源 + 监控水位线</li>
</ul>
<p><strong>ES参数汇总表：</strong></p>
<p>1、存储空间优化参数</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>级别</th>
<th>默认值</th>
<th>优化建议</th>
<th>性能收益</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>index</strong></td>
<td>字段级</td>
<td><code>true</code></td>
<td>不需要搜索的字段设为<code>false</code></td>
<td>减少20-50%存储空间</td>
<td>纯展示字段、内部ID</td>
</tr>
<tr>
<td><strong>store</strong></td>
<td>字段级</td>
<td><code>false</code></td>
<td>高频访问字段设为<code>true</code></td>
<td>减少30-70%IO开销</td>
<td>大文档的部分字段查询</td>
</tr>
<tr>
<td><strong>doc_values</strong></td>
<td>字段级</td>
<td><code>true</code></td>
<td>不聚合排序的字段设为<code>false</code></td>
<td>减少10-30%存储空间</td>
<td>纯搜索字段、过滤字段</td>
</tr>
<tr>
<td><strong>norms</strong></td>
<td>字段级</td>
<td><code>true</code></td>
<td>不需要评分的text字段设为<code>false</code></td>
<td>减少评分计算开销</td>
<td>keyword化的text字段</td>
</tr>
<tr>
<td><strong>ignore_above</strong></td>
<td>字段级</td>
<td><code>256</code></td>
<td>根据实际数据调整</td>
<td>避免超长字符串索引</td>
<td>URL、描述等长文本字段</td>
</tr>
<tr>
<td><strong>_source</strong></td>
<td>索引级</td>
<td><code>enabled</code></td>
<td>大文档可禁用或过滤</td>
<td>减少50-80%存储空间</td>
<td>仅搜索不返回原文档</td>
</tr>
</tbody></table>
<p>2、查询性能优化参数</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>级别</th>
<th>默认值</th>
<th>优化建议</th>
<th>性能收益</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>eager_global_ordinals</strong></td>
<td>字段级</td>
<td><code>false</code></td>
<td>高频聚合字段设为<code>true</code></td>
<td>减少50-90%聚合响应时间</td>
<td>分类、标签等高频聚合字段</td>
</tr>
<tr>
<td><strong>fielddata</strong></td>
<td>字段级</td>
<td><code>false</code></td>
<td>谨慎启用，优先使用keyword</td>
<td>支持text字段聚合</td>
<td>无法改为keyword的遗留字段</td>
</tr>
<tr>
<td><strong>boost</strong></td>
<td>字段级</td>
<td><code>1.0</code></td>
<td>设置字段相关性权重</td>
<td>提升搜索精度</td>
<td>多字段搜索的权重调优</td>
</tr>
<tr>
<td><strong>refresh_interval</strong></td>
<td>索引级</td>
<td><code>1s</code></td>
<td>批量导入时设为<code>-1</code></td>
<td>提升2-5倍写入性能</td>
<td>批量数据导入场景</td>
</tr>
<tr>
<td><strong>max_result_window</strong></td>
<td>索引级</td>
<td><code>10000</code></td>
<td>根据分页需求调整</td>
<td>控制内存消耗</td>
<td>深分页业务需求</td>
</tr>
</tbody></table>
<p>3、集群资源优化参数</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>级别</th>
<th>默认值</th>
<th>优化建议</th>
<th>性能收益</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>number_of_shards</strong></td>
<td>索引级</td>
<td><code>1</code></td>
<td>数据量(GB) ÷ 30GB</td>
<td>提升并行查询性能</td>
<td>大数据量索引</td>
</tr>
<tr>
<td><strong>number_of_replicas</strong></td>
<td>索引级</td>
<td><code>1</code></td>
<td>根据可用性需求调整</td>
<td>平衡性能与可用性</td>
<td>高可用vs性能权衡</td>
</tr>
<tr>
<td><strong>indices.memory.index_buffer_size</strong></td>
<td>集群级</td>
<td><code>10%</code></td>
<td>写入密集型调至15-20%</td>
<td>提升写入性能</td>
<td>高并发写入场景</td>
</tr>
<tr>
<td><strong>thread_pool.write.queue_size</strong></td>
<td>集群级</td>
<td><code>200</code></td>
<td>写入压力大时增加至1000</td>
<td>减少写入拒绝</td>
<td>写入峰值处理</td>
</tr>
<tr>
<td><strong>cluster.routing.allocation.disk.watermark.low/high</strong></td>
<td>集群级</td>
<td><code>85%/90%</code></td>
<td>根据磁盘容量规划调整</td>
<td>避免分片重分布</td>
<td>磁盘容量管理</td>
</tr>
</tbody></table>
<p>4、分析器性能参数</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>级别</th>
<th>默认值</th>
<th>优化建议</th>
<th>性能收益</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>analyzer</strong></td>
<td>字段级</td>
<td><code>standard</code></td>
<td>中文使用<code>ik_max_word</code></td>
<td>提升中文搜索效果</td>
<td>中文内容搜索</td>
</tr>
<tr>
<td><strong>search_analyzer</strong></td>
<td>字段级</td>
<td>同analyzer</td>
<td>索引用<code>ik_max_word</code>，搜索用<code>ik_smart</code></td>
<td>平衡索引大小与搜索精度</td>
<td>中文搜索优化</td>
</tr>
<tr>
<td><strong>normalizer</strong></td>
<td>字段级</td>
<td>无</td>
<td>keyword字段标准化处理</td>
<td>提升精确匹配准确性</td>
<td>大小写不敏感匹配</td>
</tr>
</tbody></table>
<h2 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h2><h3 id="节点角色配置"><a href="#节点角色配置" class="headerlink" title="节点角色配置"></a>节点角色配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主节点 - 负责集群管理</span></span><br><span class="line"><span class="attr">node.roles:</span> [<span class="string">master</span>]</span><br><span class="line"><span class="attr">node.name:</span> <span class="string">master-node-1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据节点 - 负责数据存储和查询</span></span><br><span class="line"><span class="attr">node.roles:</span> [<span class="string">data</span>, <span class="string">data_content</span>, <span class="string">data_hot</span>, <span class="string">data_warm</span>]</span><br><span class="line"><span class="attr">node.name:</span> <span class="string">data-node-1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 协调节点 - 负责查询路由和结果聚合</span></span><br><span class="line"><span class="attr">node.roles:</span> []</span><br><span class="line"><span class="attr">node.name:</span> <span class="string">coordinating-node-1</span></span><br></pre></td></tr></table></figure>

<h3 id="内存配置原则"><a href="#内存配置原则" class="headerlink" title="内存配置原则"></a>内存配置原则</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># JVM内存设置</span></span><br><span class="line"><span class="string">-Xms4g</span></span><br><span class="line"><span class="string">-Xmx4g</span>                    <span class="comment"># 堆内存不超过系统内存50%，最大32GB</span></span><br><span class="line"><span class="string">-XX:+UseG1GC</span>              <span class="comment"># 推荐G1垃圾收集器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ES配置</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span>              <span class="comment"># 锁定内存，避免交换</span></span><br><span class="line"><span class="attr">indices.memory.index_buffer_size:</span> <span class="number">10</span><span class="string">%</span>    <span class="comment"># 索引缓冲区大小</span></span><br></pre></td></tr></table></figure>

<h3 id="分片策略"><a href="#分片策略" class="headerlink" title="分片策略"></a>分片策略</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;分片设置原则&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;分片大小&quot;</span><span class="punctuation">:</span> <span class="string">&quot;单个分片20-50GB最佳&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;分片数量&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数据量(GB) ÷ 30GB&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;副本数量&quot;</span><span class="punctuation">:</span> <span class="string">&quot;至少1个副本保证高可用&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;扩展规划&quot;</span><span class="punctuation">:</span> <span class="string">&quot;主分片数确定后无法修改，需预留空间&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="监控与运维"><a href="#监控与运维" class="headerlink" title="监控与运维"></a>监控与运维</h2><h3 id="关键监控指标"><a href="#关键监控指标" class="headerlink" title="关键监控指标"></a>关键监控指标</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 集群健康状态</span></span><br><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_cluster/health?pretty&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点统计信息</span></span><br><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_nodes/stats?pretty&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 索引统计信息</span></span><br><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_stats?pretty&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="故障排查"><a href="#故障排查" class="headerlink" title="故障排查"></a>故障排查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看未分配分片原因</span></span><br><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_cluster/allocation/explain?pretty&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看慢查询日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/elasticsearch/slowlog.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看热点线程</span></span><br><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_nodes/hot_threads&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第四部分：高级搜索"><a href="#第四部分：高级搜索" class="headerlink" title="第四部分：高级搜索"></a>第四部分：高级搜索</h1><h2 id="人性化搜索功能"><a href="#人性化搜索功能" class="headerlink" title="人性化搜索功能"></a>人性化搜索功能</h2><h3 id="多字段智能搜索"><a href="#多字段智能搜索" class="headerlink" title="多字段智能搜索"></a>多字段智能搜索</h3><p>企业级搜索通常需要在多个字段中智能匹配用户输入。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 智能产品搜索 - 不同字段不同权重</span></span><br><span class="line">curl -X POST <span class="string">&quot;localhost:9200/products/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;multi_match&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;query&quot;: &quot;苹果手机&quot;,</span></span><br><span class="line"><span class="string">      &quot;fields&quot;: [</span></span><br><span class="line"><span class="string">        &quot;title^3&quot;,        // 标题权重最高</span></span><br><span class="line"><span class="string">        &quot;brand^2&quot;,        // 品牌权重高</span></span><br><span class="line"><span class="string">        &quot;description&quot;,    // 描述标准权重</span></span><br><span class="line"><span class="string">        &quot;tags^0.5&quot;       // 标签权重低</span></span><br><span class="line"><span class="string">      ],</span></span><br><span class="line"><span class="string">      &quot;type&quot;: &quot;best_fields&quot;,</span></span><br><span class="line"><span class="string">      &quot;minimum_should_match&quot;: &quot;75%&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;highlight&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;fields&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;title&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="string">      &quot;description&quot;: &#123;&quot;fragment_size&quot;: 100&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="容错搜索"><a href="#容错搜索" class="headerlink" title="容错搜索"></a>容错搜索</h3><p>容错搜索基于编辑距离算法，自动纠正用户的拼写错误，提升搜索体验。<strong>详细算法原理请参考第五部分：高级搜索原理。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模糊匹配 - 处理拼写错误</span></span><br><span class="line">curl -X POST <span class="string">&quot;localhost:9200/products/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;multi_match&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;query&quot;: &quot;iphne&quot;,     // 故意拼错</span></span><br><span class="line"><span class="string">      &quot;fields&quot;: [&quot;title&quot;, &quot;brand&quot;],</span></span><br><span class="line"><span class="string">      &quot;fuzziness&quot;: &quot;AUTO&quot;,  // 自动容错</span></span><br><span class="line"><span class="string">      &quot;prefix_length&quot;: 1,</span></span><br><span class="line"><span class="string">      &quot;max_expansions&quot;: 50</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="地理位置搜索"><a href="#地理位置搜索" class="headerlink" title="地理位置搜索"></a>地理位置搜索</h2><p>地理搜索在O2O、外卖、地图应用中非常重要。</p>
<h3 id="地理数据建模"><a href="#地理数据建模" class="headerlink" title="地理数据建模"></a>地理数据建模</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建餐厅索引</span></span><br><span class="line">curl -X PUT <span class="string">&quot;localhost:9200/restaurants&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;mappings&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &#123;&quot;type&quot;: &quot;text&quot;&#125;,</span></span><br><span class="line"><span class="string">      &quot;location&quot;: &#123;&quot;type&quot;: &quot;geo_point&quot;&#125;,     // 地理坐标点</span></span><br><span class="line"><span class="string">      &quot;area&quot;: &#123;&quot;type&quot;: &quot;geo_shape&quot;&#125;,        // 地理形状</span></span><br><span class="line"><span class="string">      &quot;cuisine_type&quot;: &#123;&quot;type&quot;: &quot;keyword&quot;&#125;,</span></span><br><span class="line"><span class="string">      &quot;rating&quot;: &#123;&quot;type&quot;: &quot;float&quot;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="距离搜索"><a href="#距离搜索" class="headerlink" title="距离搜索"></a>距离搜索</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索1公里内的餐厅，按距离排序</span></span><br><span class="line">curl -X POST <span class="string">&quot;localhost:9200/restaurants/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;bool&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;filter&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;geo_distance&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;distance&quot;: &quot;1km&quot;,</span></span><br><span class="line"><span class="string">          &quot;location&quot;: &#123;&quot;lat&quot;: 39.9042, &quot;lon&quot;: 116.4074&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;sort&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;_geo_distance&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;location&quot;: &#123;&quot;lat&quot;: 39.9042, &quot;lon&quot;: 116.4074&#125;,</span></span><br><span class="line"><span class="string">        &quot;order&quot;: &quot;asc&quot;,</span></span><br><span class="line"><span class="string">        &quot;unit&quot;: &quot;m&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="智能补全"><a href="#智能补全" class="headerlink" title="智能补全"></a>智能补全</h2><p>提供优秀搜索体验的关键功能。ES使用FST（有限状态转换器）数据结构实现高效的前缀匹配和补全建议。<strong>详细数据结构原理请参考第五部分：高级搜索原理。</strong></p>
<h3 id="补全索引设计"><a href="#补全索引设计" class="headerlink" title="补全索引设计"></a>补全索引设计</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT <span class="string">&quot;localhost:9200/products_v2&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;mappings&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;title&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;type&quot;: &quot;text&quot;,</span></span><br><span class="line"><span class="string">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class="line"><span class="string">        &quot;fields&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;suggest&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;type&quot;: &quot;completion&quot;,    // 补全字段</span></span><br><span class="line"><span class="string">            &quot;analyzer&quot;: &quot;ik_max_word&quot;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="补全查询"><a href="#补全查询" class="headerlink" title="补全查询"></a>补全查询</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自动补全查询</span></span><br><span class="line">curl -X POST <span class="string">&quot;localhost:9200/products_v2/_search&quot;</span> \</span><br><span class="line">-H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">-d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;suggest&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;title_suggest&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;prefix&quot;: &quot;手&quot;,         // 用户输入的前缀</span></span><br><span class="line"><span class="string">      &quot;completion&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;field&quot;: &quot;title.suggest&quot;,</span></span><br><span class="line"><span class="string">        &quot;size&quot;: 5,</span></span><br><span class="line"><span class="string">        &quot;skip_duplicates&quot;: true</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="数据同步方案"><a href="#数据同步方案" class="headerlink" title="数据同步方案"></a>数据同步方案</h2><p>企业级应用需要保持主数据库与ES的同步。</p>
<h3 id="同步方案选择"><a href="#同步方案选择" class="headerlink" title="同步方案选择"></a>同步方案选择</h3><table>
<thead>
<tr>
<th>方案</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>定时全量</strong></td>
<td>简单可靠</td>
<td>实时性差，资源消耗大</td>
<td>小数据量，实时性要求不高</td>
</tr>
<tr>
<td><strong>MQ异步</strong></td>
<td>解耦，高可用</td>
<td>架构复杂，一致性问题</td>
<td>微服务架构，高并发</td>
</tr>
<tr>
<td><strong>CDC捕获</strong></td>
<td>实时性最高，无侵入</td>
<td>技术门槛高，运维复杂</td>
<td>企业级，实时性要求极高</td>
</tr>
</tbody></table>
<h3 id="MQ异步同步实现"><a href="#MQ异步同步实现" class="headerlink" title="MQ异步同步实现"></a>MQ异步同步实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据同步消息</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSyncMessage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String operation;   <span class="comment">// CREATE, UPDATE, DELETE</span></span><br><span class="line">    <span class="keyword">private</span> String entityType;  <span class="comment">// PRODUCT, ORDER, USER</span></span><br><span class="line">    <span class="keyword">private</span> String entityId;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">    <span class="keyword">private</span> Long timestamp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步监听器</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;product.sync.queue&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductSyncListener</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductSearchService searchService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleProductSync</span><span class="params">(DataSyncMessage message)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;接收同步消息: &#123;&#125;&quot;</span>, message);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">switch</span> (message.getOperation()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;CREATE&quot;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;UPDATE&quot;</span>:</span><br><span class="line">                    <span class="comment">// 从数据库获取最新数据并同步到ES</span></span><br><span class="line">                    syncProductToES(message.getEntityId());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;DELETE&quot;</span>:</span><br><span class="line">                    <span class="comment">// 从ES删除文档</span></span><br><span class="line">                    searchService.deleteProduct(message.getEntityId());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;同步失败: &#123;&#125;&quot;</span>, message, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SyncException</span>(<span class="string">&quot;数据同步失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第五部分：核心原理"><a href="#第五部分：核心原理" class="headerlink" title="第五部分：核心原理"></a>第五部分：核心原理</h1><p>理解Elasticsearch的底层原理是掌握高级优化和故障排查的关键。本部分深入剖析ES的核心机制。</p>
<h2 id="ES技术架构与JVM"><a href="#ES技术架构与JVM" class="headerlink" title="ES技术架构与JVM"></a>ES技术架构与JVM</h2><h3 id="核心技术栈"><a href="#核心技术栈" class="headerlink" title="核心技术栈"></a>核心技术栈</h3><p><strong>Elasticsearch的技术基础：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;开发语言&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Java&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;核心引擎&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Apache Lucene 9.x&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;运行环境&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JVM (Java Virtual Machine)&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;最低Java版本&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JDK 11+&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;推荐Java版本&quot;</span><span class="punctuation">:</span> <span class="string">&quot;OpenJDK 17 或 Oracle JDK 17&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="为什么选择Java？"><a href="#为什么选择Java？" class="headerlink" title="为什么选择Java？"></a>为什么选择Java？</h3><p><strong>Java技术栈的优势：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;技术优势&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;成熟稳定&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Java生态成熟，大量企业级应用验证&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;性能优秀&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JIT编译器优化，长时间运行性能强劲&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;内存管理&quot;</span><span class="punctuation">:</span> <span class="string">&quot;自动垃圾回收，减少内存泄漏风险&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;跨平台&quot;</span><span class="punctuation">:</span> <span class="string">&quot;一次编写，到处运行，支持多种操作系统&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Lucene继承&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;历史原因&quot;</span><span class="punctuation">:</span> <span class="string">&quot;基于Apache Lucene，自然选择Java&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;技术积累&quot;</span><span class="punctuation">:</span> <span class="string">&quot;继承Lucene的搜索算法和优化经验&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;社区支持&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Java搜索引擎生态完善&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="倒排索引原理"><a href="#倒排索引原理" class="headerlink" title="倒排索引原理"></a>倒排索引原理</h2><h3 id="什么是倒排索引？"><a href="#什么是倒排索引？" class="headerlink" title="什么是倒排索引？"></a>什么是倒排索引？</h3><p><strong>为什么叫”倒排”索引？</strong><br>传统数据库是”正向”的：文档ID → 包含的词汇<br>倒排索引是”反向”的：词汇 → 包含该词的文档ID列表</p>
<p>原始的数据会被ES进行<strong>分词</strong>处理，分词后，词为key，原文件地址为value，这样就形成了反向的映射。</p>
<p><strong>倒排索引结构：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;原始文档&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;doc1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;我爱北京天安门&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;doc2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;北京欢迎你&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;doc3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;我爱祖国&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;倒排索引&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;我&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;doc1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;doc3&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;爱&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;doc1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;doc3&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;北京&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;doc1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;doc2&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;天安门&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;doc1&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;欢迎&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;doc2&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;你&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;doc2&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;祖国&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;doc3&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>倒排索引的优势：</strong></p>
<ul>
<li><strong>快速定位</strong>：通过词汇直接找到相关文档</li>
<li><strong>高效组合</strong>：多个词汇的交集、并集运算</li>
<li><strong>相关性评分</strong>：基于词频、逆文档频率等计算相关性</li>
</ul>
<h3 id="倒排索引存储结构"><a href="#倒排索引存储结构" class="headerlink" title="倒排索引存储结构"></a>倒排索引存储结构</h3><p><strong>完整的倒排索引包含：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;词汇字典&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;作用&quot;</span><span class="punctuation">:</span> <span class="string">&quot;存储所有不重复的词汇&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;结构&quot;</span><span class="punctuation">:</span> <span class="string">&quot;排序的词汇列表，支持快速查找&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;优化&quot;</span><span class="punctuation">:</span> <span class="string">&quot;前缀压缩、增量编码&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;倒排列表&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;作用&quot;</span><span class="punctuation">:</span> <span class="string">&quot;存储每个词汇对应的文档列表&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;内容&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;文档ID&quot;</span><span class="punctuation">,</span> <span class="string">&quot;词频TF&quot;</span><span class="punctuation">,</span> <span class="string">&quot;位置信息&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;压缩&quot;</span><span class="punctuation">:</span> <span class="string">&quot;差值编码、变长编码&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="分片与副本原理"><a href="#分片与副本原理" class="headerlink" title="分片与副本原理"></a>分片与副本原理</h2><h3 id="分片设计目的"><a href="#分片设计目的" class="headerlink" title="分片设计目的"></a>分片设计目的</h3><p><strong>分片（Shard）解决的核心问题：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;分片解决的问题&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;水平扩展&quot;</span><span class="punctuation">:</span> <span class="string">&quot;单机存储容量限制&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;并行处理&quot;</span><span class="punctuation">:</span> <span class="string">&quot;多分片并行查询提高性能&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;故障隔离&quot;</span><span class="punctuation">:</span> <span class="string">&quot;单分片故障不影响整体服务&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;分片类型&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;主分片&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Primary Shard - 负责写入和读取&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;副本分片&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Replica Shard - 主分片的完整副本&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="数据分布机制"><a href="#数据分布机制" class="headerlink" title="数据分布机制"></a>数据分布机制</h3><p><strong>文档路由算法：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文档路由公式</span></span><br><span class="line">shard_id = <span class="built_in">hash</span>(document_id) % number_of_primary_shards</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：3个主分片的路由</span></span><br><span class="line"><span class="built_in">hash</span>(<span class="string">&quot;doc1&quot;</span>) % 3 = 1  <span class="comment"># 文档分配到分片1</span></span><br><span class="line"><span class="built_in">hash</span>(<span class="string">&quot;doc2&quot;</span>) % 3 = 0  <span class="comment"># 文档分配到分片0  </span></span><br><span class="line"><span class="built_in">hash</span>(<span class="string">&quot;doc3&quot;</span>) % 3 = 2  <span class="comment"># 文档分配到分片2</span></span><br></pre></td></tr></table></figure>

<p><strong>为什么主分片数创建后不能修改？</strong><br>因为文档路由依赖主分片数的哈希计算，修改分片数会导致所有文档路由错乱，必须重建索引。</p>
<h2 id="近实时搜索原理"><a href="#近实时搜索原理" class="headerlink" title="近实时搜索原理"></a>近实时搜索原理</h2><h3 id="传统数据库-vs-ES的实时性"><a href="#传统数据库-vs-ES的实时性" class="headerlink" title="传统数据库 vs ES的实时性"></a>传统数据库 vs ES的实时性</h3><table>
<thead>
<tr>
<th>特性</th>
<th>传统数据库</th>
<th>Elasticsearch</th>
</tr>
</thead>
<tbody><tr>
<td><strong>写入方式</strong></td>
<td>立即写磁盘</td>
<td>先写内存，定期刷盘</td>
</tr>
<tr>
<td><strong>搜索延迟</strong></td>
<td>无延迟</td>
<td>1秒内（可配置）</td>
</tr>
<tr>
<td><strong>性能权衡</strong></td>
<td>写入慢，查询快</td>
<td>写入快，微延迟搜索</td>
</tr>
</tbody></table>
<h3 id="ES实时搜索流程"><a href="#ES实时搜索流程" class="headerlink" title="ES实时搜索流程"></a>ES实时搜索流程</h3><p><strong>三个关键概念：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Buffer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;作用&quot;</span><span class="punctuation">:</span> <span class="string">&quot;内存缓冲区，临时存储新文档&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;特点&quot;</span><span class="punctuation">:</span> <span class="string">&quot;写入速度快，但不可搜索&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Refresh&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;作用&quot;</span><span class="punctuation">:</span> <span class="string">&quot;将Buffer内容刷新为可搜索的Segment&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;频率&quot;</span><span class="punctuation">:</span> <span class="string">&quot;默认1秒，可配置&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;结果&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数据变为可搜索状态&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Flush&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;作用&quot;</span><span class="punctuation">:</span> <span class="string">&quot;将Segment持久化到磁盘&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;频率&quot;</span><span class="punctuation">:</span> <span class="string">&quot;默认30分钟或Translog达到512MB&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;结果&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数据永久保存&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>完整的写入和搜索流程：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;写入流程&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;步骤1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;文档写入内存Buffer&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;步骤2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;同时写入Translog（事务日志）&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;步骤3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;每1秒refresh，Buffer → Segment（可搜索）&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;步骤4&quot;</span><span class="punctuation">:</span> <span class="string">&quot;定期flush，Segment → 磁盘（持久化）&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;搜索流程&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;步骤1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;查询所有可搜索的Segment&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;步骤2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;合并多个Segment的结果&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;步骤3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;排序并返回最终结果&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="分词器原理"><a href="#分词器原理" class="headerlink" title="分词器原理"></a>分词器原理</h2><h3 id="分词器组成架构"><a href="#分词器组成架构" class="headerlink" title="分词器组成架构"></a>分词器组成架构</h3><p><strong>分词器（Analyzer）三层结构：</strong>两个filter，肉夹馍结构</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;分词器结构&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;字符过滤器&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Character Filter - 预处理文本（去HTML标签等）&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;分词器&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Tokenizer - 将文本拆分为词汇单元&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;词汇过滤器&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Token Filter - 后处理词汇（小写、停词等）&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="标准分词器工作流程"><a href="#标准分词器工作流程" class="headerlink" title="标准分词器工作流程"></a>标准分词器工作流程</h3><p><strong>处理流程示例：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;示例文本&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello World! ES-Learning.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;处理流程&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;1. 字符过滤&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello World! ES-Learning. (无变化，字符过滤的是html标签等内容)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;2. 分词处理&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Hello&quot;</span><span class="punctuation">,</span> <span class="string">&quot;World&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ES&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Learning&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;3. 词汇过滤&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;hello&quot;</span><span class="punctuation">,</span> <span class="string">&quot;world&quot;</span><span class="punctuation">,</span> <span class="string">&quot;es&quot;</span><span class="punctuation">,</span> <span class="string">&quot;learning&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;4. 最终结果&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;hello&quot;</span><span class="punctuation">,</span> <span class="string">&quot;world&quot;</span><span class="punctuation">,</span> <span class="string">&quot;es&quot;</span><span class="punctuation">,</span> <span class="string">&quot;learning&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="中文分词特殊性"><a href="#中文分词特殊性" class="headerlink" title="中文分词特殊性"></a>中文分词特殊性</h3><p><strong>中文分词的挑战：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;中文分词挑战&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;无明显分隔符&quot;</span><span class="punctuation">:</span> <span class="string">&quot;中文词汇之间没有空格分隔&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;语义依赖&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需要理解上下文确定词汇边界&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;标准分词器&quot;</span><span class="punctuation">:</span> <span class="string">&quot;按字符拆分，效果差&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;专业分词器&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IK、jieba等，基于词典和算法&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;示例对比&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;原文&quot;</span><span class="punctuation">:</span> <span class="string">&quot;我爱北京天安门&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;标准分词&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;我&quot;</span><span class="punctuation">,</span> <span class="string">&quot;爱&quot;</span><span class="punctuation">,</span> <span class="string">&quot;北&quot;</span><span class="punctuation">,</span> <span class="string">&quot;京&quot;</span><span class="punctuation">,</span> <span class="string">&quot;天&quot;</span><span class="punctuation">,</span> <span class="string">&quot;安&quot;</span><span class="punctuation">,</span> <span class="string">&quot;门&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;IK分词&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;我&quot;</span><span class="punctuation">,</span> <span class="string">&quot;爱&quot;</span><span class="punctuation">,</span> <span class="string">&quot;北京&quot;</span><span class="punctuation">,</span> <span class="string">&quot;天安门&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="聚合原理"><a href="#聚合原理" class="headerlink" title="聚合原理"></a>聚合原理</h2><h3 id="聚合类型划分"><a href="#聚合类型划分" class="headerlink" title="聚合类型划分"></a>聚合类型划分</h3><p><strong>指标聚合（Metric Aggregations）</strong></p>
<ul>
<li><strong>定义</strong>：对一组文档进行数值计算，返回单个或多个数值结果</li>
<li><strong>特点</strong>：输入文档组 → 输出数值</li>
<li><strong>类型</strong>：单值指标（avg、sum、min、max）、多值指标（stats、percentiles）</li>
</ul>
<p><strong>桶聚合（Bucket Aggregations）</strong></p>
<ul>
<li><strong>定义</strong>：根据条件将文档分组到不同的”桶”中</li>
<li><strong>特点</strong>：输入文档组 → 输出文档桶（可嵌套子聚合）</li>
<li><strong>类型</strong>：terms分组、range范围、date_histogram时间分组</li>
</ul>
<h3 id="聚合执行原理"><a href="#聚合执行原理" class="headerlink" title="聚合执行原理"></a>聚合执行原理</h3><p><strong>聚合的执行过程：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;聚合执行流程&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;1. 文档收集&quot;</span><span class="punctuation">:</span> <span class="string">&quot;根据query条件收集匹配的文档&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;2. 桶分组&quot;</span><span class="punctuation">:</span> <span class="string">&quot;按照桶聚合条件将文档分到不同桶中&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;3. 指标计算&quot;</span><span class="punctuation">:</span> <span class="string">&quot;对每个桶内的文档执行指标聚合&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;4. 结果合并&quot;</span><span class="punctuation">:</span> <span class="string">&quot;合并各分片的聚合结果&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;5. 返回数据&quot;</span><span class="punctuation">:</span> <span class="string">&quot;返回最终的聚合统计结果&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="分页原理"><a href="#分页原理" class="headerlink" title="分页原理"></a>分页原理</h2><h3 id="深分页问题根本原因"><a href="#深分页问题根本原因" class="headerlink" title="深分页问题根本原因"></a>深分页问题根本原因</h3><p><strong>from/size分页的性能问题：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;问题分析&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;from_size工作原理&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;步骤1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;每个分片都查询 from + size 条数据&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;步骤2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;协调节点收集所有分片的结果&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;步骤3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;全局排序后取 from 到 from+size 的数据&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;步骤4&quot;</span><span class="punctuation">:</span> <span class="string">&quot;丢弃前 from 条数据，返回 size 条数据&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;性能损耗&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;内存消耗&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需要在内存中处理 from + size 条数据&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;网络传输&quot;</span><span class="punctuation">:</span> <span class="string">&quot;每个分片传输 from + size 条数据&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;CPU消耗&quot;</span><span class="punctuation">:</span> <span class="string">&quot;大量数据的排序和比较操作&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="search-after原理"><a href="#search-after原理" class="headerlink" title="search_after原理"></a>search_after原理</h3><p><strong>基于游标的分页机制：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;search_after原理&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;工作机制&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;无需跳过&quot;</span><span class="punctuation">:</span> <span class="string">&quot;不需要跳过前面的数据&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;游标定位&quot;</span><span class="punctuation">:</span> <span class="string">&quot;基于上一页最后一条记录的排序值定位&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;恒定性能&quot;</span><span class="punctuation">:</span> <span class="string">&quot;每次查询性能恒定，不随页数增加而降低&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;必要条件&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;必须排序&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query中必须包含sort字段&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;唯一性保证&quot;</span><span class="punctuation">:</span> <span class="string">&quot;排序字段组合必须能唯一标识文档&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;常用方案&quot;</span><span class="punctuation">:</span> <span class="string">&quot;业务字段 + _id 组合排序&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="查询优化原理"><a href="#查询优化原理" class="headerlink" title="查询优化原理"></a>查询优化原理</h2><h3 id="filter-vs-must-性能差异"><a href="#filter-vs-must-性能差异" class="headerlink" title="filter vs must 性能差异"></a>filter vs must 性能差异</h3><p><strong>性能差异的根本原因：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;性能差异分析&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;must查询特点&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;相关性评分&quot;</span><span class="punctuation">:</span> <span class="string">&quot;每个匹配的文档都需要计算_score&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;TF-IDF算法&quot;</span><span class="punctuation">:</span> <span class="string">&quot;计算词频、逆文档频率、字段长度标准化&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;排序影响&quot;</span><span class="punctuation">:</span> <span class="string">&quot;评分结果影响文档排序&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;无法缓存&quot;</span><span class="punctuation">:</span> <span class="string">&quot;评分是动态计算的，结果难以缓存&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;filter查询特点&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;不计算评分&quot;</span><span class="punctuation">:</span> <span class="string">&quot;_score始终为0，节省大量计算&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;布尔判断&quot;</span><span class="punctuation">:</span> <span class="string">&quot;只判断匹配/不匹配，二进制结果&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;查询缓存&quot;</span><span class="punctuation">:</span> <span class="string">&quot;结果可以缓存，重复查询极快&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;位运算优化&quot;</span><span class="punctuation">:</span> <span class="string">&quot;内部使用BitSet进行快速位运算&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="查询缓存机制"><a href="#查询缓存机制" class="headerlink" title="查询缓存机制"></a>查询缓存机制</h3><p><strong>filter查询的缓存机制：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;filter缓存机制&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;缓存对象&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BitSet位图 - 每个文档一个bit标识匹配状态&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;缓存条件&quot;</span><span class="punctuation">:</span> <span class="string">&quot;查询频率高、结果相对稳定的filter&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;缓存淘汰&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LRU算法，内存不足时淘汰最少使用的缓存&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;缓存命中&quot;</span><span class="punctuation">:</span> <span class="string">&quot;相同filter查询直接返回缓存结果，无需重新计算&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;缓存大小&quot;</span><span class="punctuation">:</span> <span class="string">&quot;默认最多缓存10000个filter查询&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="容错搜索原理"><a href="#容错搜索原理" class="headerlink" title="容错搜索原理"></a>容错搜索原理</h2><h3 id="模糊查询（Fuzzy-Query）算法基础"><a href="#模糊查询（Fuzzy-Query）算法基础" class="headerlink" title="模糊查询（Fuzzy Query）算法基础"></a>模糊查询（Fuzzy Query）算法基础</h3><p><strong>编辑距离（Levenshtein Distance）算法：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;编辑距离定义&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;概念&quot;</span><span class="punctuation">:</span> <span class="string">&quot;将一个字符串转换为另一个字符串所需的最少编辑操作次数&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;操作类型&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;插入字符&quot;</span><span class="punctuation">,</span> <span class="string">&quot;删除字符&quot;</span><span class="punctuation">,</span> <span class="string">&quot;替换字符&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;示例&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;cat → bat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1次操作（替换c为b）&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cat → cats&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1次操作（插入s）&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;cat → ca&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1次操作（删除t）&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>ES模糊查询的工作流程：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;模糊查询流程&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;步骤1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;用户输入查询词（如：&#x27;iphne&#x27;）&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;步骤2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ES根据fuzziness参数确定最大编辑距离&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;步骤3&quot;</span><span class="punctuation">:</span> <span class="string">&quot;在倒排索引中查找编辑距离范围内的所有词汇&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;步骤4&quot;</span><span class="punctuation">:</span> <span class="string">&quot;计算每个匹配词的相似度得分&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;步骤5&quot;</span><span class="punctuation">:</span> <span class="string">&quot;返回按相似度排序的结果&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="fuzziness参数详解"><a href="#fuzziness参数详解" class="headerlink" title="fuzziness参数详解"></a>fuzziness参数详解</h3><p><strong>AUTO模式的智能判断：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;AUTO模式规则&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;0-2个字符&quot;</span><span class="punctuation">:</span> <span class="string">&quot;不允许编辑（fuzziness=0）&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;3-5个字符&quot;</span><span class="punctuation">:</span> <span class="string">&quot;允许1次编辑（fuzziness=1）&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;6+个字符&quot;</span><span class="punctuation">:</span> <span class="string">&quot;允许2次编辑（fuzziness=2）&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;示例应用&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;输入&#x27;go&#x27;&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fuzziness=0，只匹配精确的&#x27;go&#x27;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;输入&#x27;cat&#x27;&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fuzziness=1，可匹配&#x27;bat&#x27;, &#x27;car&#x27;, &#x27;cats&#x27;等&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;输入&#x27;iphone&#x27;&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fuzziness=2，可匹配&#x27;iphne&#x27;, &#x27;ipone&#x27;, &#x27;iphone&#x27;等&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="前缀长度和扩展限制"><a href="#前缀长度和扩展限制" class="headerlink" title="前缀长度和扩展限制"></a>前缀长度和扩展限制</h3><p><strong>prefix_length参数作用：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;前缀长度优化&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;目的&quot;</span><span class="punctuation">:</span> <span class="string">&quot;提高查询性能，减少候选词汇数量&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;原理&quot;</span><span class="punctuation">:</span> <span class="string">&quot;要求前N个字符必须精确匹配&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;示例&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;prefix_length=2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#x27;iphone&#x27; → 只考虑以&#x27;ip&#x27;开头的词汇&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;性能提升&quot;</span><span class="punctuation">:</span> <span class="string">&quot;大幅减少需要计算编辑距离的词汇数量&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>max_expansions参数控制：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;扩展数量限制&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;目的&quot;</span><span class="punctuation">:</span> <span class="string">&quot;防止查询过于消耗资源&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;默认值&quot;</span><span class="punctuation">:</span> <span class="string">&quot;50个候选词&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;工作机制&quot;</span><span class="punctuation">:</span> <span class="string">&quot;找到50个匹配词后停止搜索&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;权衡考虑&quot;</span><span class="punctuation">:</span> <span class="string">&quot;较小值提升性能，较大值提高召回率&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="容错搜索的性能优化"><a href="#容错搜索的性能优化" class="headerlink" title="容错搜索的性能优化"></a>容错搜索的性能优化</h3><p><strong>性能影响因素：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;性能考量&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;计算复杂度&quot;</span><span class="punctuation">:</span> <span class="string">&quot;O(m*n)，m和n分别为两个字符串长度&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;索引影响&quot;</span><span class="punctuation">:</span> <span class="string">&quot;需要遍历词汇字典计算编辑距离&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;优化策略&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;使用prefix_length&quot;</span><span class="punctuation">:</span> <span class="string">&quot;减少候选词数量&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;控制max_expansions&quot;</span><span class="punctuation">:</span> <span class="string">&quot;限制计算量&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;合理设置fuzziness&quot;</span><span class="punctuation">:</span> <span class="string">&quot;避免过度宽松的匹配&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="智能补全原理"><a href="#智能补全原理" class="headerlink" title="智能补全原理"></a>智能补全原理</h2><h3 id="Completion-Suggester核心机制"><a href="#Completion-Suggester核心机制" class="headerlink" title="Completion Suggester核心机制"></a>Completion Suggester核心机制</h3><p><strong>Finite State Transducer (FST) 数据结构：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;FST数据结构&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;定义&quot;</span><span class="punctuation">:</span> <span class="string">&quot;有限状态转换器，专门为前缀匹配优化的数据结构&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;优势&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;空间效率&quot;</span><span class="punctuation">:</span> <span class="string">&quot;相比Trie树节省50-80%内存&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;查询速度&quot;</span><span class="punctuation">:</span> <span class="string">&quot;O(k)复杂度，k为前缀长度&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;共享前缀&quot;</span><span class="punctuation">:</span> <span class="string">&quot;相同前缀的词汇共享存储路径&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;构建过程&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;词汇排序&quot;</span><span class="punctuation">:</span> <span class="string">&quot;按字典序排列所有补全词汇&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;路径共享&quot;</span><span class="punctuation">:</span> <span class="string">&quot;相同前缀合并为同一路径&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;状态压缩&quot;</span><span class="punctuation">:</span> <span class="string">&quot;最小化状态数量&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>FST vs 传统Trie树对比：</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>Trie树</th>
<th>FST</th>
</tr>
</thead>
<tbody><tr>
<td><strong>内存使用</strong></td>
<td>高（每个节点独立）</td>
<td>低（路径共享压缩）</td>
</tr>
<tr>
<td><strong>查询速度</strong></td>
<td>O(k)</td>
<td>O(k)</td>
</tr>
<tr>
<td><strong>构建复杂度</strong></td>
<td>简单</td>
<td>复杂（需排序和最小化）</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>小数据集</td>
<td>大数据集、生产环境</td>
</tr>
</tbody></table>
<h3 id="补全查询的执行流程"><a href="#补全查询的执行流程" class="headerlink" title="补全查询的执行流程"></a>补全查询的执行流程</h3><p><strong>查询处理步骤：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;补全查询流程&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;1. 前缀匹配&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;输入&quot;</span><span class="punctuation">:</span> <span class="string">&quot;用户输入前缀（如：&#x27;手&#x27;）&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;处理&quot;</span><span class="punctuation">:</span> <span class="string">&quot;在FST中查找以该前缀开始的所有路径&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;结果&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获得候选词汇列表&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;2. 权重排序&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;输入&quot;</span><span class="punctuation">:</span> <span class="string">&quot;候选词汇列表&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;处理&quot;</span><span class="punctuation">:</span> <span class="string">&quot;根据每个词汇的权重（weight）进行排序&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;结果&quot;</span><span class="punctuation">:</span> <span class="string">&quot;按相关性/热度排序的建议列表&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;3. 结果过滤&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;输入&quot;</span><span class="punctuation">:</span> <span class="string">&quot;排序后的建议列表&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;处理&quot;</span><span class="punctuation">:</span> <span class="string">&quot;应用size参数限制和skip_duplicates去重&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;结果&quot;</span><span class="punctuation">:</span> <span class="string">&quot;最终的补全建议&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="权重计算策略"><a href="#权重计算策略" class="headerlink" title="权重计算策略"></a>权重计算策略</h3><p><strong>权重设置的常见策略：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;权重策略&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;搜索热度&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;数据来源&quot;</span><span class="punctuation">:</span> <span class="string">&quot;历史搜索统计&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;计算方式&quot;</span><span class="punctuation">:</span> <span class="string">&quot;搜索次数的对数值&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;示例&quot;</span><span class="punctuation">:</span> <span class="string">&quot;weight = log(search_count + 1)&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;业务重要性&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;数据来源&quot;</span><span class="punctuation">:</span> <span class="string">&quot;业务规则定义&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;计算方式&quot;</span><span class="punctuation">:</span> <span class="string">&quot;分类权重 × 基础权重&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;示例&quot;</span><span class="punctuation">:</span> <span class="string">&quot;热销商品权重 × 2&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;时间衰减&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;数据来源&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数据的新鲜度&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;计算方式&quot;</span><span class="punctuation">:</span> <span class="string">&quot;基础权重 × 时间衰减因子&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;示例&quot;</span><span class="punctuation">:</span> <span class="string">&quot;weight = base_weight × 0.9^days_old&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="补全性能优化"><a href="#补全性能优化" class="headerlink" title="补全性能优化"></a>补全性能优化</h3><p><strong>内存优化策略：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;内存优化&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;FST加载&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;机制&quot;</span><span class="punctuation">:</span> <span class="string">&quot;FST存储在堆外内存（off-heap）&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;优势&quot;</span><span class="punctuation">:</span> <span class="string">&quot;不占用JVM堆内存，不影响GC&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;注意&quot;</span><span class="punctuation">:</span> <span class="string">&quot;重启节点时需要重新加载&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;数据压缩&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;前缀共享&quot;</span><span class="punctuation">:</span> <span class="string">&quot;相同前缀的词汇共享存储&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;后缀最小化&quot;</span><span class="punctuation">:</span> <span class="string">&quot;相同后缀也会合并&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;压缩比&quot;</span><span class="punctuation">:</span> <span class="string">&quot;通常可达到50-80%的空间节省&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>查询性能优化：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;查询优化&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;分片级并行&quot;</span><span class="punctuation">:</span> <span class="string">&quot;每个分片并行处理补全查询&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;结果合并&quot;</span><span class="punctuation">:</span> <span class="string">&quot;协调节点合并各分片结果并重新排序&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;缓存策略&quot;</span><span class="punctuation">:</span> <span class="string">&quot;频繁查询的前缀结果可被缓存&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;性能指标&quot;</span><span class="punctuation">:</span> <span class="string">&quot;通常可达到&lt;10ms的响应时间&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="多语言补全支持"><a href="#多语言补全支持" class="headerlink" title="多语言补全支持"></a>多语言补全支持</h3><p><strong>中文补全的特殊处理：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;中文补全挑战&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;拼音支持&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;需求&quot;</span><span class="punctuation">:</span> <span class="string">&quot;支持拼音首字母和全拼输入&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;实现&quot;</span><span class="punctuation">:</span> <span class="string">&quot;使用拼音分析器预处理&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;示例&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#x27;手机&#x27; → [&#x27;sj&#x27;, &#x27;shouji&#x27;, &#x27;shou&#x27;, &#x27;ji&#x27;]&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;多输入法&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;全拼&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shouji → 手机&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;简拼&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sj → 手机&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;混合&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shou机 → 手机&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;同音词处理&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;问题&quot;</span><span class="punctuation">:</span> <span class="string">&quot;拼音相同的词汇竞争&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;解决&quot;</span><span class="punctuation">:</span> <span class="string">&quot;结合权重和上下文进行排序&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="术语概念深度解析"><a href="#术语概念深度解析" class="headerlink" title="术语概念深度解析"></a>术语概念深度解析</h2><h3 id="为什么ES被称为”索引”？"><a href="#为什么ES被称为”索引”？" class="headerlink" title="为什么ES被称为”索引”？"></a>为什么ES被称为”索引”？</h3><p>这是很多初学者的疑惑，让我们深入理解ES术语体系的历史演进：</p>
<p><strong>多重含义解析：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;ES中索引的三重含义&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;数据容器层面&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;定义&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Index = Database，存储相关数据的逻辑集合&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;例子&quot;</span><span class="punctuation">:</span> <span class="string">&quot;创建students索引存储学生信息&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;类比&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MySQL中的database概念&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;搜索引擎层面&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;定义&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Index = 倒排索引，快速检索的数据结构&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;例子&quot;</span><span class="punctuation">:</span> <span class="string">&quot;为每个字段构建倒排索引加速搜索&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;类比&quot;</span><span class="punctuation">:</span> <span class="string">&quot;图书馆的索引目录&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;历史传承层面&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;定义&quot;</span><span class="punctuation">:</span> <span class="string">&quot;继承Lucene搜索引擎的术语体系&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;原因&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ES基于Apache Lucene构建&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;影响&quot;</span><span class="punctuation">:</span> <span class="string">&quot;保持与搜索引擎生态的术语一致性&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>术语对比澄清：</strong></p>
<table>
<thead>
<tr>
<th>ES术语</th>
<th>数据库术语</th>
<th>搜索引擎术语</th>
<th>实际含义</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Index</strong></td>
<td>Database</td>
<td>Inverted Index</td>
<td>数据集合 + 搜索索引</td>
</tr>
<tr>
<td><strong>Document</strong></td>
<td>Row</td>
<td>Document</td>
<td>JSON格式的数据记录</td>
</tr>
<tr>
<td><strong>Field</strong></td>
<td>Column</td>
<td>Field</td>
<td>文档中的属性字段</td>
</tr>
<tr>
<td><strong>Mapping</strong></td>
<td>Schema</td>
<td>Mapping</td>
<td>字段类型和属性定义</td>
</tr>
</tbody></table>
<p><strong>设计哲学体现：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;ES设计理念&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;搜索为王&quot;</span><span class="punctuation">:</span> <span class="string">&quot;一切设计都围绕快速搜索展开&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;倒排优先&quot;</span><span class="punctuation">:</span> <span class="string">&quot;每个字段都默认构建倒排索引&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;近实时&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数据写入后1秒内即可搜索&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;分布式&quot;</span><span class="punctuation">:</span> <span class="string">&quot;天然支持水平扩展和高可用&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这种命名方式强调了ES的核心价值：<strong>不仅是数据存储，更是高效的搜索引擎</strong>。</p>
<hr>
<h1 id="实战总结"><a href="#实战总结" class="headerlink" title="实战总结"></a>实战总结</h1><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="索引设计原则"><a href="#索引设计原则" class="headerlink" title="索引设计原则"></a>索引设计原则</h3><ol>
<li><strong>合理选择字段类型</strong>：text用于搜索，keyword用于过滤和聚合</li>
<li><strong>优化mapping配置</strong>：禁用不需要的功能（doc_values、norms等）</li>
<li><strong>设计合适的分片</strong>：单分片20-50GB，分片数=数据量÷30GB</li>
<li><strong>使用别名管理</strong>：便于索引重建和版本切换</li>
</ol>
<h3 id="查询优化技巧"><a href="#查询优化技巧" class="headerlink" title="查询优化技巧"></a>查询优化技巧</h3><ol>
<li><strong>优先使用filter</strong>：不需要评分的条件用filter，性能更好</li>
<li><strong>合理设置分页</strong>：大数据量使用search_after替代from/size</li>
<li><strong>控制聚合粒度</strong>：避免高基数字段的大量聚合</li>
<li><strong>启用查询缓存</strong>：重复查询使用request_cache</li>
</ol>
<h3 id="生产环境配置"><a href="#生产环境配置" class="headerlink" title="生产环境配置"></a>生产环境配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关键配置建议</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">production-cluster</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">es-node-1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存设置</span></span><br><span class="line"><span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">-Xms16g</span></span><br><span class="line"><span class="string">-Xmx16g</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能优化</span></span><br><span class="line"><span class="attr">indices.memory.index_buffer_size:</span> <span class="number">10</span><span class="string">%</span></span><br><span class="line"><span class="attr">thread_pool.write.queue_size:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">cluster.routing.allocation.disk.watermark.low:</span> <span class="number">85</span><span class="string">%</span></span><br><span class="line"><span class="attr">cluster.routing.allocation.disk.watermark.high:</span> <span class="number">90</span><span class="string">%</span></span><br></pre></td></tr></table></figure>

<h2 id="常见问题解决"><a href="#常见问题解决" class="headerlink" title="常见问题解决"></a>常见问题解决</h2><h3 id="集群状态异常"><a href="#集群状态异常" class="headerlink" title="集群状态异常"></a>集群状态异常</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 诊断分片分配问题</span></span><br><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_cluster/allocation/explain?pretty&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看未分配分片</span></span><br><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_cat/shards?h=index,shard,state,unassigned.reason&amp;v&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="性能问题排查"><a href="#性能问题排查" class="headerlink" title="性能问题排查"></a>性能问题排查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看慢查询</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/elasticsearch/slowlog.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析热点线程</span></span><br><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_nodes/hot_threads&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查队列状态</span></span><br><span class="line">curl -X GET <span class="string">&quot;localhost:9200/_nodes/stats/thread_pool?pretty&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<p><em>本指南涵盖了Elasticsearch从入门到精通的完整知识体系，建议收藏备用，在实际项目中遇到问题时可随时查阅。</em></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/elasticsearch/" rel="tag"><i class="fa fa-tag"></i> elasticsearch</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/12/29/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/RocketMq4/" rel="prev" title="RocketMq">
                  <i class="fa fa-chevron-left"></i> RocketMq
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/08/10/AI/RAG/" rel="next" title="RAG">
                  RAG <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">晋ICP备 - 20007839号-1 </a>
  </div>

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hynis</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">1.3m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">19:08</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
